# Puddle

Puddle is a domain specific language implemented as a term project for the course NSWI164 Model-driven Development. This repository contains an Eclipse workspace with all the Eclipse projects
implementing Puddle. These are:

- org.mk4h.puddle
- org.mk4h.puddle.ide
- org.mk4h.puddle.tests
- org.mk4h.puddle.ui
- org.mk4h.puddle.ui.tests

These were generated as part of default Xtext project and most of them do not contain any changes from their generated state.
The only custom code is contained in the org.mk4h.puddle project.

## Assignment

The goal of the term project is to develop a DSL and transformation for simple music score notation.
The program should consume a DSL as given below and it should produce output for [LilyPond music engraver](http://lilypond.org/).  Sample input:
```
phrase aaa { a+2 2  c-2 8 "La"}
phrase bbb { e 2 "Ta" \aaa }

song "AAA" {
    b 2 "UU"
    \aaa
    \bbb
}
```
 Sample output:
```
\version "2.18.2"

\header {
    title = "AAA"
}

\score {
    <<
    \new Staff {
        \key c \major
        \time 4/4

        \absolute {
            b2
            a''2 c,,8
            e2 a''2 c,,8
        }
    }
    \addlyrics {
        "UU" "" "La" "Ta" "" "La"
    }
    >>
}
```
The format of the input notation is as follows:
The input consists of exactly one song. The song has  a title and the score with lyrics. The score with
lyrics consists of a series of notes. Each note is given by the note name (e.g. “a”), the octave (e.g.
“+2” or “-2”), duration (1 = full note, 2 = half note, ...), and the lyrics syllable in quotation marks. The octave is optional. The lyrics syllable is optional too. To differentiate the octave from the note duration, the octave always comes with a sign (+ or  -).

It is possible to define a fragment of a score with lyrics (called phrase). This is defined as shown in
the example. The phrase has an identifier and the score with lyrics. The phrase may be referenced
from another phrase or a song. It is forbidden to have a cyclic dependency inside a phrase or
between several phrases.

The output should be as given in the sample output above. You can assume that the song has always
the time signature 4/4 and that it is set in key C major.

## Solution

The solution is implemented by the the org.mk4h.puddle* projects contained in this repository which make up an Eclipse workspace. They mostly contain code generated by Eclipse for default Xtext project. The only project containing custom code is the org.mk4h.puddle project.

### Extensions
Compared to the assignment, Puddle implements customization of the following additional song features:

- key,
- time signature,
- default octave,
- default note duration,
- per phrase default octave,
- per phrase default note duration.

To allow the original input included in the assignment to work, all of these features are optional, with defaults as specified by the assignment or by Lilypond.
The defaults are:
- key C major,
- time signature 4/4,
- default octave is the Lilypond default octave, which is the octave below middle C,
- default note duration is the Lilypond default duration, which is 1/4.

The song default octave and note duration propagate to each used phrase if not overriden by per phrase default.

### Grammar

The core of the solution is the Xtext grammar, which defines the syntax of the Puddle language and is used to generate the Ecore model. This was the most time consuming part, as defining an unambiguous grammar with set of terminals that do not collide took some trial and error. The main problem were the explicit whitespace requirements in the Note specification, where we don't allow whitespace between pitch and the optional octave and allow whitespace between the other, optional parts. This was not explicitly required by the assignment, but I implemented it just to play with the hidden terminals in Xtext.

Each puddle input contains one song.

First, the input can specify [0-*] reusable phrases using the phrase block. Each phrase block contains optional default octave override, optional default note duration override and then [0-*] entries, which can either be simple Notes or references to other phrases. Phrase can be referenced by it's name with `\` prefix. Note entry contains the pitch, optional octave, optional duration and optional text.


Example of full phrase definition:
```
phrase <name> {
    octave +2
    default duration 2
    \otherphrasename
    a+1 4 "La"
    c
}
```
The name can cotain any alfanumeric character or an underscore, but cannot begin with a number.
The result of this definition will be a phrase which includes phrase with the name `otherphrasename`, which will inherit the `+2` default octave and `2` default duration. Then an `a` note with octave `+3` with the duration `4` and text `La`. Lastly the phrase will include note `c` with octave `+2`, duration `2` and empty string for text. The optional text part can contain arbitrary string delimited by single or double quotes.


The only required part of the input is the song block, with the only required part being the name of the song. The song block can then optionaly contain any of the song key, time signature, default octave and default note duration.

Example of a full song block:
```
song "SkakalPes" {
    key c major
    time 4/4
    octave +1
    default duration 4

    g "Ská" g "kal" e 2 "pes"
}
```

The notes and phrase references work the same as in the phrase block. The only difference is the name, which has to be enclosed in single or double quotes and allows arbitrary string to be used, and the addition of key and time signature, which is set for the whole song and cannot be overriden by phrases.

### Value convertor

To simplify the parsing of octave specification, we add a custom terminal SIGNED_INT and corresponding value converter `PuddleValueConverterService` in the org.mk4h.conversion package in the org.mk4h.puddle project. This converter extends the `DefaultTerminalConverters` and adds a method which parses the octave specification into an instance of `Integer`. This custom converter is required due to the mandatory sign prefix.

### Generator

The generator in the org.mk4h.generator package of the org.mk4h.puddle project implements the transformation from Puddle syntax, represented as an instance of the Ecore metamodel generated from the Xtext grammar, into the syntax of Lilypond. We use the Xtend language to simplify the implementation, as it allows easy string interpolation and adds some nice syntax sugar to pure Java. The transformation is pretty straight forward. We use the info in the song block to tell Lilypond the key and time signature. Then we go through the entries of the song block and get the notes, expanding and inlining each phrase.

We then go through the entries a second time, again expanding and inlining each phrase, parsing the lyrics this time.

To allow the use of generator as commandling application, we have added the `generateJavaMain = true` to the GeneratePuddle.mwe2 generator block and modified the generated Main.java to output the files in the current directory.
This allows us to either start new eclipse instance and use it with syntax highlighting, automatic generation and everything, or run the generator through eclipse itself as standalone java application, or generate runnable JAR so that the generator can be used as CLI application or probably as a library.

### Examples

The org.mk4h.puddle project contains two pieces of music written in puddle. The `test.puddle` was taken from the assignemnt itself. The more interesting one is `SkakalPes.puddle`, which contains the classical Czech folk song Skákal pes. These can be used by running the org.mk4h.generator package in the org.mk4h.puddle project directly from Eclipse or by generating runnable JAR from the org.mk4h.generator and using it as commandline application.

